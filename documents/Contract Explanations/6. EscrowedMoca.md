# EscrowedMoca (esMoca)

EscrowedMoca provides a flexible, secure mechanism for distributing protocol rewards while incentivizing long-term alignment. 

Through its redemption system, it balances immediate liquidity needs with value accrual for patient participants, creating a sustainable token economy that benefits all stakeholders.


## Overview

EscrowedMoca (esMoca) is a non-transferable token representing Moca tokens held in escrow within the protocol ecosystem.
- Functions as a reward token that can be redeemed for Moca through various redemption options
- Each redemption option has different lock periods and conversion rates
- Similar to early bond redemption mechanisms with penalties for immediate liquidity

### Key Features

- **1:1 conversion from MOCA to esMoca** (no penalty on entry)
- **Multiple redemption pathways** with configurable lock periods and conversion rates
- **Penalty system** that redistributes value to voters and treasury
- **Non-transferable by default** (except for whitelisted addresses)
- **Integrated risk management** with pause and freeze mechanisms

### Objective of esMoca

1. **Incentivize long-term holding** - Users who wait longer receive full value
2. **Provide liquidity options** - Users can exit early at a penalty
3. **Redistribute value** - Penalties from early redemptions benefit other ecosystem participants

### The Escrow-Redemption Lifecycle

Native Moca → esMoca (1:1, no penalty) → Choose Redemption Option → Receive Native Moca or wMoca (with/without penalty)

## Redemption System

### Redemption Options

The contract supports multiple redemption options, each defined by:
- **Lock Duration**: How long tokens are locked before redemption (0 for instant)
- **Receivable Percentage**: What percentage of esMoca converts to MOCA (up to 100%)
- **Enabled Status**: Whether the option is currently available

Example redemption options:
```
Option 0: Standard   - 180 days lock, 100% receivable (no penalty)
Option 1: Early      - 30 days lock,  80% receivable (20% penalty)  
Option 2: Instant    - 0 days lock,   50% receivable (50% penalty)
```

### How Redemption Works

1. **Selection Phase** (`selectRedemptionOption`)
   - User chooses a redemption option, `expectedOption`, and `redemptionAmount`
   - `esMoca` is immediately burned
   - Redemption is scheduled based on lock duration
   - If instant (0 lock), native `Moca` is transferred immediately (wraps to wMoca if transfer fails within gas limit)
   - If locked, user must wait and claim later
   - Pending redemptions are tracked in `TOTAL_MOCA_PENDING_REDEMPTION` and `userTotalMocaPendingRedemption`

2. **Claim Phase** (`claimRedemptions`)
   - After lock period expires, user claims their Moca by providing an array of redemption timestamps
   - Can claim multiple redemptions in a single transaction
   - Native `Moca` is transferred (wraps to wMoca if transfer fails within gas limit)
   - No additional penalties at claim time

### Penalty Mechanics

When users redeem with a penalty:
- The penalty amount is the difference between `esMoca` burned and `moca` received
- Penalties are split between:
  - **Voters**: Percentage defined by `VOTERS_PENALTY_PCT` (can be 0, meaning all penalties go to treasury)
  - **Treasury**: Remaining percentage (100% if `VOTERS_PENALTY_PCT` is 0)

This creates a value redistribution mechanism where early exits benefit long-term participants.

**Important Design Choice**: 
```solidity
// We block redemptions where penalty rounds to 0
require(penaltyAmount > 0, Errors.InvalidAmount());
```
This prevents gaming the system with micro-transactions that would avoid penalties due to rounding, and protects the protocol from rounding/misconfiguration errors.

## Key Functions

### For Users

**`escrowMoca()`**
- Converts native MOCA (sent via `msg.value`) to esMoca at 1:1 ratio
- No approval needed (native Moca transfer)
- Mints esMoca to caller

**`selectRedemptionOption(uint256 redemptionOption, DataTypes.RedemptionOption calldata expectedOption, uint256 redemptionAmount)`**
- Initiates redemption process
- Burns esMoca immediately
- Schedules or executes redemption based on lock duration
- Transfers native Moca (or wMoca if native transfer fails within gas limit) for instant redemptions
- Updates `TOTAL_MOCA_PENDING_REDEMPTION` and `userTotalMocaPendingRedemption` for locked redemptions
- `expectedOption` must match the stored redemption option (protects against parameter changes between transaction submission and execution)

**`claimRedemptions(uint256[] calldata redemptionTimestamps)`**
- Claims MOCA after lock period expires for multiple redemptions in one call
- Accepts array of redemption timestamps to claim
- Transfers native Moca (or wMoca if native transfer fails within gas limit)
- Only for non-instant redemptions

### State Tracking

**`TOTAL_MOCA_PENDING_REDEMPTION`**: Tracks MOCA that has been redeemed but not yet claimed.
- Incremented when a redemption is scheduled (non-instant redemptions)
- Decremented when redemptions are claimed
- Represents locked MOCA awaiting claim by users

**`userTotalMocaPendingRedemption`**: Per-user tracking of pending redemptions.
- Enables efficient emergency exit operations
- Tracks user's total pending MOCA across all scheduled redemptions

### For CronJob

**`escrowMocaOnBehalf(address[] calldata users, uint256[] calldata amounts)`**
- Batch mint esMoca to multiple users
- Accepts native Moca via `msg.value` (must equal sum of amounts)
- Used for protocol rewards distribution (called bi-weekly)
- Only callable by CronJob role

**`claimPenalties()`**
- Withdraws accumulated penalties for voters/treasury
- Transfers to esMoca treasury address
- Tracks claimed vs unclaimed amounts via `CLAIMED_PENALTY_FROM_VOTERS` and `CLAIMED_PENALTY_FROM_TREASURY`
- Transfers native Moca (or wMoca if native transfer fails within gas limit)
- Only callable by CronJob role
- **Can be called when paused** (allows penalty recovery during emergency)

### For Asset Managers

**`releaseEscrowedMoca(uint256 amount)`**
- Instant 1:1 conversion for asset managers
- Burns caller's esMoca and transfers native Moca (or wMoca if native transfer fails within gas limit)
- No penalties applied
- Only callable by Asset Manager role

### For EscrowedMoca Admin

**`setRedemptionOption(uint256 redemptionOption, uint128 lockDuration, uint128 receivablePct)`**
- Creates or updates a redemption option
- Sets lock duration (0 for instant) and receivable percentage
- Automatically enables the option
- `receivablePct` must be > 0 and <= 10,000 (2dp precision)
- `lockDuration` maximum: 888 days (~2.4 years)

**`setRedemptionOptionStatus(uint256 redemptionOption, bool enable)`**
- Enables or disables an existing redemption option
- Allows temporary disabling without deleting configuration

**`setVotersPenaltyPct(uint256 votersPenaltyPct)`**
- Updates the percentage of penalties allocated to voters
- Can be set to 0 (all penalties go to treasury)
- Range: 0 to 10,000 (2 decimal precision, exclusive upper bound)

**`setWhitelistStatus(address[] calldata addresses, bool isWhitelisted)`**
- Adds or removes addresses from the transfer whitelist (batch operation)
- Only whitelisted addresses can transfer esMoca
- Primary use case: Asset Manager transferring to VotingController to deposit rewards/subsidies
- **Can be called when paused** (allows whitelist management during emergency)

**`setMocaTransferGasLimit(uint256 newMocaTransferGasLimit)`**
- Updates the gas limit for native Moca transfers
- Minimum: 2300 (required for EOA transfers)
- Typical values: 2300 for EOA, 4029 for Gnosis Safe with fallback
- **Can be called when paused** (allows gas limit adjustments during emergency)

## Access Control & Roles

The system uses role-based access control via AccessControlEnumerable:

| **Role**                  | **Permissions**                    | **Purpose**                        |
|---------------------------|------------------------------------|------------------------------------|
| **User**                  | escrowMoca                         | Standard user operations           |
|                           | selectRedemptionOption             |                                    |
|                           | claimRedemptions                   |                                    |
|---------------------------|------------------------------------|------------------------------------|
| **CronJob**               | escrowMocaOnBehalf                 | Periodic rewards distribution      |
|                           | claimPenalties                     |                                    |
|---------------------------|------------------------------------|------------------------------------|
| **Asset Manager**         | releaseEscrowedMoca                | Protocol operations                |
|---------------------------|------------------------------------|------------------------------------|
| **EscrowedMoca Admin**    | setRedemptionOption                | Parameter configuration            |
|                           | setRedemptionOptionStatus          |                                    |
|                           | setVotersPenaltyPct                |                                    |
|                           | setWhitelistStatus                 |                                    |
|                           | setMocaTransferGasLimit            |                                    |
|---------------------------|------------------------------------|------------------------------------|
| **Monitor**               | pause                              | Emergency response (automated)     |
|---------------------------|------------------------------------|------------------------------------|
| **Global Admin**          | unpause                            | Emergency response (multisig)      |
|                           | freeze                             |                                    |
|---------------------------|------------------------------------|------------------------------------|
| **Emergency Exit Handler**| emergencyExit (for multiple users) | Asset recovery when frozen         |
|---------------------------|------------------------------------|------------------------------------|

### Role Hierarchy

- **High-level admins** (ESCROWED_MOCA_ADMIN_ROLE, EMERGENCY_EXIT_HANDLER_ROLE, MONITOR_ADMIN_ROLE, CRON_JOB_ADMIN_ROLE) managed by DEFAULT_ADMIN_ROLE
- **High-frequency operational roles** (MONITOR_ROLE, CRON_JOB_ROLE) managed by their dedicated admins
- Enables flexible role rotation without global admin intervention

## Transfer Restrictions

esMoca is **non-transferable** by default. This ensures:
- Rewards stay with intended recipients
- No secondary markets for esMoca

**Exception: Whitelist System**
- Specific addresses can be whitelisted to transfer esMoca
- Primary use case: Asset Manager transferring to VotingController to deposit rewards/subsidies
- Only the **sender** must be whitelisted (recipient does not need to be whitelisted)
- Both `transfer()` and `transferFrom()` are restricted to whitelisted senders
- **Whitelisted transfers work even when contract is paused** (allows critical asset movement during emergency)

## Risk Management

### Three-Tier Safety System

1. **Pausable** 
   - Monitor role can pause (automated response)
   - Global Admin can unpause (manual review)
   - Blocks all user operations when paused

2. **Freeze Mechanism**
   - One-way kill switch (cannot be unfrozen)
   - Requires contract to be paused first
   - Enables emergency exit functionality

3. **Emergency Exit**
   - Only available when frozen
   - `emergencyExit(address[] calldata users)`: Users or Emergency Exit Handler can transfer all esMoca balance + pending redemptions
   - Users can call with their own address (array of length 1)
   - Emergency Exit Handler can batch process multiple users
   - Transfers native Moca (or wMoca if native transfer fails within gas limit)

### Risk Hierarchy
```
Normal Operation → Monitor Pauses → Global Admin Reviews
                                            ↓
                                   [Unpause or Freeze]
                                            ↓
                                  [If Frozen: Emergency Exit]
```

## Technical Implementation Details

### Precision and Limits

- **Percentage Precision**: 2 decimal places (10,000 = 100%, 100 = 1%, 1 = 0.01%)
- **Maximum Lock Duration**: 888 days (~2.4 years)
- **Redemption Options**: Unlimited number, each independently configurable via mapping

### State Tracking

The contract maintains several key state variables:
- `TOTAL_MOCA_PENDING_REDEMPTION`: Total MOCA locked in scheduled redemptions awaiting claim
- `ACCRUED_PENALTY_TO_VOTERS/TREASURY`: Accumulated penalties (in native Moca)
- `CLAIMED_PENALTY_FROM_VOTERS/TREASURY`: Already distributed penalties
- `MOCA_TRANSFER_GAS_LIMIT`: Gas limit for native Moca transfers (minimum 2300, configurable)
- `WMOCA`: Address of wrapped Moca contract (used as fallback if native transfer fails)
- `ESCROWED_MOCA_TREASURY`: Treasury address for penalty claims

### Redemption Storage Pattern

```solidity
mapping(address user => mapping(uint256 timestamp => uint256 mocaReceivable)) redemptionSchedule;
mapping(address user => uint256 totalMocaPendingRedemption) userTotalMocaPendingRedemption;
```

- Multiple redemptions can be scheduled for the same timestamp, and they aggregate automatically
- `mocaReceivable` is stored per user per timestamp
- Penalties are calculated on-the-fly during redemption selection, not stored
- `userTotalMocaPendingRedemption` enables efficient emergency exit operations

### Native Moca Transfer & Wrapping Mechanism

The contract uses native Moca for all transfers but includes a safety mechanism:
- All Moca transfers attempt native transfer first (using `.call{value: amount}(gasLimit)`)
- If the native transfer fails within the `MOCA_TRANSFER_GAS_LIMIT`, the contract automatically wraps Moca to wMoca and transfers wMoca instead
- This ensures compatibility with contracts that don't accept native Moca (e.g., some contracts require explicit receive/fallback functions with sufficient gas)
- Gas limit is configurable by EscrowedMocaAdmin (minimum 2300, typical values: ~2300 for EOA, ~4029 for Gnosis Safe)

## Integration Points

### With VotingController
- Asset Manager can transfer esMoca as voting rewards
- Requires whitelist configuration
- Enables reward distribution in esMoca instead of Moca

### With VotingEscrowMoca
- Users can lock esMoca (instead of Moca) to create veMoca positions
- Provides flexibility in how users engage with the voting system

## Design Rationale

### Why Non-Transferable?

Making esMoca non-transferable prevents:
- Circumvention of vesting schedules through secondary markets
- Complex tracking of redemption rights across addresses

### Why Multiple Redemption Options?

Different users have different liquidity needs:
- **Long-term holders**: Maximum value through patient redemption
- **Liquidity seekers**: Immediate access at a cost
- **Balanced users**: Middle-ground options

### Why Split Penalties?

Penalties serve dual purposes:
1. **Compensate voters**: Those who lock longer benefit from others' impatience
2. **Fund treasury**: Protocol treasury for self-sustainability

The configurable split allows governance to balance these objectives.

## Security Considerations

1. **Reentrancy Protection**: Native Moca transfers use gas-limited calls with automatic wrapping fallback
2. **Integer Overflow**: Redemption calculations protected by Solidity 0.8.x checks
3. **Access Control**: All privileged functions have explicit role checks
4. **State Consistency**: Burn happens before external calls in redemption flow
5. **Precision Loss**: Explicit checks prevent zero-penalty redemptions (prevents rounding abuse)
6. **Native Transfer Safety**: Automatic wrapping to wMoca if native transfer fails, ensuring transfers always succeed
7. **Gas Limit Configuration**: Configurable gas limits for native transfers prevent DoS from gas-guzzling fallback functions
8. **Redemption Option Protection**: `expectedOption` parameter ensures the redemption option hasn't changed between transaction submission and execution

## Constructor & Initialization

The constructor sets up all immutable parameters and initial role assignments:

```solidity
constructor(
    address globalAdmin,
    address escrowedMocaAdmin,
    address monitorAdmin,
    address cronJobAdmin,
    address monitorBot,
    address escrowedMocaTreasury,
    address emergencyExitHandler,
    address assetManager,
    uint256 votersPenaltyPct,
    address wMoca_,
    uint256 mocaTransferGasLimit
)
```

**Key Validations:**
- All addresses must be non-zero
- `votersPenaltyPct <= 10,000` (can be 0, meaning all penalties to treasury)
- `wMoca_` must be non-zero
- `mocaTransferGasLimit >= 2300` gas

**Role Setup:**
- DEFAULT_ADMIN_ROLE → globalAdmin (can manage all role admins)
- ESCROWED_MOCA_ADMIN_ROLE → escrowedMocaAdmin (managed by DEFAULT_ADMIN)
- MONITOR_ADMIN_ROLE → monitorAdmin (managed by DEFAULT_ADMIN)
- CRON_JOB_ADMIN_ROLE → cronJobAdmin (managed by DEFAULT_ADMIN)
- EMERGENCY_EXIT_HANDLER_ROLE → emergencyExitHandler (managed by DEFAULT_ADMIN)
- ASSET_MANAGER_ROLE → assetManager (managed by DEFAULT_ADMIN)
- MONITOR_ROLE → monitorBot (managed by MONITOR_ADMIN)
- CRON_JOB_ROLE → not assigned at deployment (managed by CRON_JOB_ADMIN)

---

# Coverage

1. Note that require statements are reflected as "yellow", although tests for them exist (but clear should they be converted to if conditions). Likely bug.
2. Coverage was ran focussing on EscrowedMoca.sol and its tests, the other contracts should be ignored as their test files were discarded when running coverage.

```bash
╭---------------------------------------------------+------------------+------------------+-----------------+-----------------╮
| File                                              | % Lines          | % Statements     | % Branches      | % Funcs         |
+=============================================================================================================================+
| src/AccessController.sol                          | 30.16% (38/126)  | 35.71% (35/98)   | 0.00% (0/16)    | 22.50% (9/40)   |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| src/EscrowedMoca.sol                              | 98.91% (182/184) | 98.38% (182/185) | 20.91% (23/110) | 100.00% (25/25) |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| src/IssuerStakingController.sol                   | 12.77% (12/94)   | 12.64% (11/87)   | 1.89% (1/53)    | 7.14% (1/14)    |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| src/LowLevelWMoca.sol                             | 50.00% (3/6)     | 40.00% (2/5)     | 0.00% (0/1)     | 100.00% (1/1)   |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| src/libraries/EpochMath.sol                       | 0.00% (0/18)     | 0.00% (0/19)     | 100.00% (0/0)   | 0.00% (0/9)     |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| test/4. EscrowedMoca/AllPenaltiesToTreasury.t.sol | 80.00% (4/5)     | 75.00% (3/4)     | 100.00% (0/0)   | 100.00% (1/1)   |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| test/4. EscrowedMoca/EscrowedMoca.t.sol           | 83.33% (60/72)   | 80.00% (48/60)   | 100.00% (0/0)   | 100.00% (12/12) |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| test/utils/MockUSD8.sol                           | 33.33% (2/6)     | 33.33% (1/3)     | 100.00% (0/0)   | 33.33% (1/3)    |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| test/utils/MockWMoca.sol                          | 0.00% (0/27)     | 0.00% (0/23)     | 0.00% (0/7)     | 0.00% (0/7)     |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| test/utils/TestingHarness.sol                     | 86.11% (31/36)   | 85.71% (30/35)   | 100.00% (0/0)   | 33.33% (1/3)    |
|---------------------------------------------------+------------------+------------------+-----------------+-----------------|
| Total                                             | 57.84% (332/574) | 60.12% (312/519) | 12.83% (24/187) | 44.35% (51/115) |
╰---------------------------------------------------+------------------+------------------+-----------------+-----------------╯
```