# AccessController: Frequency-Based Role Architecture

AccessController is the central authority for all roles and privileges across the system.

## Table of Contents

- [Executive Summary](#executive-summary)
- [The Challenge of Secure Operations](#the-challenge-of-secure-operations)
- [The Key Insight](#the-key-insight)
- [Core Innovation: Risk-weighted, Frequency-Based Access Control](#core-innovation-risk-weighted-frequency-based-access-control)
- [Roles: Organizational Structure](#roles-organizational-structure)
- [Risk Matrix, Security Model, Defenses](#risk-matrix-security-model-defenses)
  - [Risk Matrix](#risk-matrix)
  - [Defense Layers](#defense-layers)
  - [Why AccessController is Not Pausable](#why-accesscontroller-is-not-pausable)
  - [Attack Surface Analysis](#attack-surface-analysis)
  - [Security State Transitions](#security-state-transitions)
- [Detailed Role Specifications](#detailed-role-specifications)
- [Operational Model + Execution Workflows](#operational-model--execution-workflows)
  - [Three-Tiered Operational Model](#three-tiered-operational-model-frequency-principle-in-action)
  - [Execution flows](#execution-flows)
  - [Emergency Response](#emergency-response-if-needed)
  - [Other ad-hoc operations](#other-ad-hoc-operations-no-executive-approval-required)
- [Summary and Key Outcomes](#summary-and-key-outcomes)
- [Comparative Analysis: Traditional vs Frequency-Based RBAC](#comparative-analysis-traditional-vs-frequency-based-rbac)
- [Deployment Process](#deployment-process)
- [Appendix](#appendix)

## Executive Summary

The AccessController eliminates bottlenecks in daily operations while maintaining executive oversight for strategic decisions by implementing a frequency-based role hierarchy that aligns administrative authority with operational demands.

**Design Approach**  
Instead of static hierarchies, permissions are assigned by evaluating both the frequency of function calls and their impact: {call frequency, function impact}.
- High-frequency, low/mid-impact operational roles have dedicated admins for timely action
- Low-frequency, high-impact roles are managed directly by the global admin

Authority to update roles is also mapped to operational needs:
- High-frequency roles allow their admins to add or remove addresses as required (e.g., risk bots, cron jobs)

| **Traditional Limitations**                        | **Frequency-Based Solution**                |
|----------------------------------------------------|---------------------------------------------|
| Exec approval for everything                       | High-frequency roles = dedicated admins     |
| Routine ops bottle-necked                          | Strategic roles = exec oversight            |
| Security model ignores operational reality         | Authority matches operational need          |
| Emergency response delayed or bottle-necked        | Emergency powers always on tap              |

**Core Principles:**
- Practical hierarchy: frequent-change roles = dedicated admins
- Strategic oversight: rare, high-impact = execs only
- Override safety: global admin always in control
- Multi-sig stacked for admin roles: no single point of failure

**Key Benefits:**
- Operational efficiency: Teams manage routine tasks without executive delays
- Strategic oversight: Critical decisions undergo rigorous governance review
- Security containment: Role isolation limits the impact of potential compromises
- Emergency readiness: Emergency procedures remain immediately accessible

## The Challenge of Secure Operations

Every decentralized protocol faces a fundamental tension: how to enable rapid operational responses while maintaining strict security controls? 
- Too much bureaucracy creates dangerous delays. 
- Too little oversight invites catastrophic mistakes.

Traditional access control systems force an difficult choice:
- Grant broad permissions to operators (fast but risky)
- Require executive approval for everything (secure but slow)

**Understanding the challenge**

Traditional access control systems create operational bottlenecks by requiring executive approval for all privileged operations. 
Approval process can introduce dangerous delays, when monitoring systems detect anomalies and need immediate response, or when automated systems require routine maintenance.

Consider a scenario where automated monitoring detects a potential security issue at 2 AM:
- Delays caused by the team needing to rotate monitoring addresses or pause contracts immediately could allow problems to escalate.
- The AccessController system addresses this tension through a simple observation that reshapes how we think about permissions.

*It recognizes that not all privileged operations carry the same risk, or require the same level of oversight.*

## The Key Insight

Not all administrative tasks are created equal. 

*Some actions happen daily:*
- Rotating monitoring bots
- Processing scheduled operations

*Others happen rarely:*
- Changing protocol fees
- Updating voting parameters
- Recovering emergency funds

**Additionally, regardless of their frequency, the impact of these tasks are also varied.**

This reshapes how we think about permissions and roles. 
- Both the **frequency** and **impact** of an action should determine its approval process.
- Hence, roles and hierarchy should be based on a pair-wise evaluation of frequency and impact of tasks.

**This insight drives our entire security architecture**
- Achieve both speed and security without compromise, by matching administrative overhead, impact of outcome and operational frequency.
- Resulting in reduction of friction for common operations while ensuring safeguards for critical ones.

## Core Innovation: Risk-weighted, Frequency-Based Access Control

The AccessController addresses this by creating distinct paths for operations; organizing roles according to how frequently they need to be managed:

- **High-Frequency Operations**: Include monitoring, automation, and routine maintenance. These are assigned dedicated administrators to avoid delays, ensuring rapid responses without compromising security.
- **Low-Frequency Strategic Operations**: Cover protocol parameters, asset management, and emergency procedures. These remain under executive oversight to allow for careful consideration.

>**TLDR:**
- The level of approval required should correspond to how often a role is exercised; frequent actions need less friction, rare or high-impact actions need more oversight.
- This is why we use a frequency-based access model, paired off with impact/risk.

### Implementation 

Roles are classified by how often they need to be managed:

| **High-Frequency Operations**            | **Low-Frequency Operations**    |
|------------------------------------------|---------------------------------|
| Bot rotation, monitoring                 | Protocol parameter changes      |
| Epoch processing                         | Asset management decisions      |
| Emergency responses                      | Governance modifications        |
| **Need:** Instant response               | **Need:** Deliberate review     |
| **Solution:** Dedicated admins           | **Solution:** Executive control |

This separation delivers operational efficiency and strong governance.

---

# Roles: Organizational Structure

The system organizes roles into four tiers based on operational frequency and risk profile.

**Roles: Overview**
```lua
`DEFAULT_ADMIN_ROLE` 
├── MONITOR_ADMIN_ROLE ──────────► MONITOR_ROLE
├── CRON_JOB_ADMIN_ROLE ─────────► CRON_JOB_ROLE
├── PAYMENTS_CONTROLLER_ADMIN_ROLE
├── VOTING_CONTROLLER_ADMIN_ROLE
├── VOTING_ESCROW_MOCA_ADMIN_ROLE
├── ESCROWED_MOCA_ADMIN_ROLE
├── ISSUER_STAKING_CONTROLLER_ADMIN_ROLE
├── ASSET_MANAGER_ROLE
└── EMERGENCY_EXIT_HANDLER_ROLE
```

**Roles: Hierarchy breakdown**
```lua
DEFAULT_ADMIN_ROLE              (GlobalAdmin: Senior Leadership)     
├── Operational Admins          (Manage frequent tasks)
│   ├── MONITOR_ADMIN_ROLE      (Controls pause bots)               
│   │   └── MONITOR_ROLE        (Calls pause across contracts; EOA BOT)
│   └── CRON_JOB_ADMIN_ROLE     (Controls automation)   
│       └── CRON_JOB_ROLE       (Periodic epoch ops & pool management; EOA BOT)
│   
└── Strategic Roles         
    ├── PAYMENTS_CONTROLLER_ADMIN_ROLE  [Parameter updates]
    ├── VOTING_CONTROLLER_ADMIN_ROLE    [Parameter updates]
    ├── VOTING_ESCROW_MOCA_ADMIN_ROLE   [Parameter updates]
    ├── ESCROWED_MOCA_ADMIN_ROLE        [Parameter updates]
    ├── ISSUER_STAKING_CONTROLLER_ADMIN_ROLE  [Parameter updates]
    ├── ASSET_MANAGER_ROLE              [Asset management]
    └── EMERGENCY_EXIT_HANDLER_ROLE     [Emergency functions]

```

- Admin roles have authority to add or remove addresses for the specific roles they oversee.
- Monitor and Cron roles have dedicated admins serving as structural "middle-managers"; the rest are managed directly by `DEFAULT_ADMIN_ROLE`.
- In turn, `DEFAULT_ADMIN_ROLE` supervises `MONITOR_ADMIN_ROLE` & `CRON_JOB_ADMIN_ROLE`.

**Why dedicated admins?**
- Frequent operational changes shouldn't bottleneck on executive approval. *[i.e. epoch ops, bot changes]*
- Tiering for these high-frequency roles, creates isolation to reduces risk and contain damage in the event of exploit.

## Example

If an operational admin is compromised:
- Attacker can control bot operations, but not protocol parameters.
- Role isolation prevents escalation beyond their scope.
- Executive override remains available due to enforced hierarchy.
- Impact is limited to operational disruption; funds and core settings stay protected.
- Global admin can promptly revoke access and restore normal operations.

<span style="color:red">__Blast radius is intentionally limited by design.__</span>

**Roles: Multi-sig Configuration**

```lua
DEFAULT_ADMIN_ROLE                                  (SeniorLeadership: 3/5 Multi-sig)
├── MONITOR_ADMIN_ROLE ──────────► MONITOR_ROLE     (DevOps1: 2/3 Multi-sig)
├── CRON_JOB_ADMIN_ROLE ─────────► CRON_JOB_ROLE    (DevOps2: 2/3 Multi-sig)
├── PAYMENTS_CONTROLLER_ADMIN_ROLE                  (DevOps3: 2/3 Multi-sig)
├── VOTING_CONTROLLER_ADMIN_ROLE                    (DevOps4: 2/3 Multi-sig)                                               
├── VOTING_ESCROW_MOCA_ADMIN_ROLE                   (DevOps5: 2/3 Multi-sig)                                               
├── ESCROWED_MOCA_ADMIN_ROLE                        (DevOps6: 2/3 Multi-sig)                                               
├── ISSUER_STAKING_CONTROLLER_ADMIN_ROLE            (DevOps7: 2/3 Multi-sig)
├── ASSET_MANAGER_ROLE                              (DatTeam: 2/3 Multi-sig)
└── EMERGENCY_EXIT_HANDLER_ROLE                     [EOA address for bot execution. Can only be assigned by DEFAULT_ADMIN_ROLE]
```
Avoid using a single DevOps multi-sig address for all roles, as this would centralize risk instead of isolating it.

**Roles: Actors Involved**
```
SeniorLeadership → DEFAULT_ADMIN_ROLE → Grant/Revoke strategic roles
DAT Team         → ASSET_MANAGER_ROLE → Execute asset withdrawals
DevOps Team      → PAYMENTS_CONTROLLER_ADMIN_ROLE, VOTING_CONTROLLER_ADMIN_ROLE, VOTING_ESCROW_MOCA_ADMIN_ROLE, ESCROWED_MOCA_ADMIN_ROLE, ISSUER_STAKING_CONTROLLER_ADMIN_ROLE
```

# Risk Matrix, Security Model, Defenses

**System Architecture Flow**
```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            MOCA ECOSYSTEM                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐                  │
│  │   AddressBook   │◄───┤ AccessController│───►│ All Contracts   │                  │
│  │  (Immutable)    │    │  (Upgradeable)  │    │  (Query ACL)    │                  │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘                  │
│           │                       │                                                 │
│           ▼                       ▼                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐                  │
│  │PaymensController│    │ VotingController│    │VotingEscrowMoca │                  │
│  │                 │◄──►│                 │◄──►│                 │                  │
│  │ • Verification  │    │ • Vote Mgmt     │    │ • Lock Mgmt     │                  │
│  │ • Fee Mgmt      │    │ • Reward Dist   │    │ • Delegation    │                  │
│  │ • Subsidy Calc  │    │ • Epoch Mgmt    │    │ • veToken       │                  │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### **Risk Matrix**

```
                    RISK LEVEL: LOW ◄────────────────────────────────► HIGH
┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
│ OPERATIONAL     │ ADMINISTRATIVE  │ STRATEGIC       │ EMERGENCY       │
│ (High Freq)     │ (Med Freq)      │ (Low Freq)      │ (Crisis Only)   │
├─────────────────┼─────────────────┼─────────────────┼─────────────────┤
│ MONITOR_ROLE    │ MONITOR_ADMIN   │ GLOBAL_ADMIN    │ EMERGENCY_EXIT  │
│ • pause()       │ • Manage        │ • unpause()     │ • emergencyExit │
│ • Automated     │   monitors      │ • freeze()      │ • Asset exfil   │
│   alerts        │ • Role mgmt     │ • Ultimate      │ • Kill switch   │
│                 │                 │   authority     │                 │
├─────────────────┼─────────────────┼─────────────────┤                 │
│ CRON_JOB_ROLE   │ CRON_JOB_ADMIN  │ ASSET_MANAGER   │                 │
│ • createPool()  │ • Manage cron   │ • withdrawUncl- │                 │
│ • finalizeEpoch │   jobs          │   aimed()       │                 │
│ • createLockFor │ • Role mgmt     │ • Asset ops     │                 │
│ • Automated     │                 │                 │                 │
│   operations    │                 │                 │                 │
├─────────────────┼─────────────────┼─────────────────┤                 │
│                 │                 │ PAYMENTS_ADMIN  │                 │
│                 │                 │ • Config mgmt   │                 │
│                 │                 │ • Fee settings  │                 │
│                 │                 │                 │                 │
│                 │                 │ VOTING_ADMIN    │                 │
│                 │                 │ • Voting config │                 │
│                 │                 │ • Pool mgmt     │                 │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
```

## DEFENSE LAYERS

We implement a layered approach, enabling strict risk containment, while allowing flexible operations: 

1. Role Isolation: Operational roles cannot access strategic functions, and vice versa; preventing cascade failures.
2. Multi-Signature Protection: All admin roles require distributed approval, with thresholds aligned to risk levels.
3. Override Mechanisms: Global admin can intervene in any role, ensuring no permanent lockouts.

This demonstrates the system's robustness in handling diverse scenarios.

**Exception:**
Some admin roles would be granted to EOA addresses *temporarily* to execute automated tasks.
- For example, cronJob for batch creation of pools.
- Upon completion, role to be revoked from EOA.

**Each admin role will be anchored to a fixed multi-sig; regardless the temporal additions/removals of other EOA scripts.**

### Why AccessController is Not Pausable

Unlike operational contracts, AccessController deliberately excludes pausable functionality:

1. **Multi-sig Protection**: All role management already requires multi-sig coordination, providing inherent security
2. **Emergency Response**: During crises, the ability to revoke compromised roles is critical - pausability would block this
3. **No Deadlock Risk**: Role permission checks must remain functional for unpause/freeze operations
4. **Clear Security Model**: Fast emergency response via monitor pauses on operational contracts, while role management remains secure through multi-sig

This design ensures that even during protocol emergencies, the access control layer remains fully operational for critical role management tasks.

### ATTACK SURFACE ANALYSIS  

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                              ATTACK SURFACE ANALYSIS                          │
├─────────────────┬─────────────────┬─────────────────┬─────────────────────────┤
│ ATTACK VECTOR   │ LIKELIHOOD      │ IMPACT          │ MITIGATION              │
├─────────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│ Signature Forge │ Medium          │ High            │ • EIP712 + nonces       │
│                 │                 │                 │ • Multi-sig validation  │
├─────────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│ Double Voting   │ High            │ High            │ • Forward-booking       │
│                 │                 │                 │ • State validation      │
├─────────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│ Fee Manipulation│ Medium          │ Medium          │ • Delay periods         │
│                 │                 │                 │ • Admin controls        │
├─────────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│ Re-entrancy     │ Low             │ High            │ • Checks-Effects-Inter  │
│                 │                 │                 │ • State updates first   │
├─────────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│ Access Control  │ Low             │ Critical        │ • Multi-layer ACL       │
│ Bypass          │                 │                 │ • Role separation       │
├─────────────────┼─────────────────┼─────────────────┼─────────────────────────┤
│ Economic Attack │ Medium          │ High            │ • Staking requirements  │
│                 │                 │                 │ • Fee structures        │
└─────────────────┴─────────────────┴─────────────────┴─────────────────────────┘
```

### Security State Transitions

```
                    NORMAL ◄──────────────────────► PAUSED ◄──────► FROZEN
                      │                               │              │
                      │                               │              │
    ┌─────────────────┴─────────────────┐             │              │
    │                                   │             │              │
    ▼                                   ▼             ▼              ▼
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│  User   │  │Verifier │  │ Issuer  │  │Delegate │  │ Monitor │  │Emergency│
│Actions  │  │Actions  │  │Actions  │  │Actions  │  │Actions  │  │Handler  │
│         │  │         │  │         │  │         │  │         │  │Actions  │
│• Vote   │  │• Verify │  │• Create │  │• Vote   │  │• Pause  │  │• Exit   │
│• Lock   │  │• Stake  │  │• Fees   │  │• Fees   │  │         │  │• Exfil  │
│• Claim  │  │• Claim  │  │• Claim  │  │• Claim  │  │         │  │         │
└─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘
    ✓            ✓           ✓           ✓           ✓            ✓
    ✗            ✗           ✗           ✗           ✗           ✓
    ✗            ✗           ✗           ✗           ✗           ✓

Legend: ✓ = Allowed, ✗ = Blocked
```

**Example: Attack -> Impact -> Mitigation**

```lua
| Attack Vector           | Likelihood | Impact   | Mitigation                         |
|-------------------------|------------|----------|------------------------------------|
| Bot compromise          | Medium     | Limited  | Role isolation, quick rotation     | [monitor,cron]
| Admin role compromised  | Low        | High     | Multi-sig, global override         | [unless GlobalAdmin multi-sig was infiltrated]
```

## Detailed Role Specifications

🔴 **Tier 1: Supreme Governance**
`DEFAULT_ADMIN_ROLE` (Global Admin)
- Override Power: Can override ANY role decision
- Purpose: Final authority and emergency failsafe
- Frequency: Very rare (emergencies, hierarchy changes)

*Why this matters*: This role serves as the ultimate authority, ensuring no operational issue can permanently lock out executive control.

`EMERGENCY_EXIT_HANDLER_ROLE`
- Purpose: Last-resort asset recovery when system is frozen
- Holders: (flexible as situation demands)
  1. Assigned to a bot by Global Admin. Not mandatory to be assigned pre-crisis. 
  2. Alternatively, can be assigned to multi-sig for a slow and deliberate pace of exit.
- Activation: Only after system freeze by global admin

Rationale: Emergency functions must be available but tightly controlled

🟡 **Tier 2: Strategic Roles (Low Frequency, High Impact)**

`PAYMENTS_CONTROLLER_ADMIN_ROLE`
- Controls: protocol fees, subsidy percentages, and payment configurations
- Impact: Direct economic parameters
- Updates: Governance proposals only

*Rationale*: Economic parameters require deliberate review and approval

`VOTING_CONTROLLER_ADMIN_ROLE`
- Controls: Voting parameters, delegate fees, registration requirements
- Impact: Governance mechanics
- Updates: Following community decisions

*Rationale*: Voting mechanics affect protocol governance; require careful consideration

`VOTING_ESCROW_MOCA_ADMIN_ROLE`
- Controls: VotingEscrowMoca contract parameters (e.g., lock durations, penalty rates, emergency unlocks)
- Impact: Directly affects veMOCA mechanics and user incentives
- Updates: As needed, typically following governance or security review

*Rationale*: Specialized admin for veToken logic ensures rapid response to protocol or market changes without global admin bottleneck

`ESCROWED_MOCA_ADMIN_ROLE`
- Controls: Escrowed MOCA (esMOCA) minting, burning, and migration operations
- Impact: Manages esMOCA supply, vesting, and conversion processes
- Updates: As required for reward distribution, vesting schedule changes, or migration events

*Rationale*: Segregated authority for escrowed token management reduces risk and enables flexible reward program adjustments

`ISSUER_STAKING_CONTROLLER_ADMIN_ROLE`
- Controls: IssuerStakingController contract parameters and configuration
- Impact: Manages issuer staking mechanics, requirements, and protocol settings
- Updates: As needed for staking parameter adjustments, requirement changes, or protocol updates

*Rationale*: Dedicated admin for issuer staking ensures efficient management of staking operations while maintaining proper oversight

`ASSET_MANAGER_ROLE`
- Function: Withdraw protocol fees and unclaimed assets (rewards/subsidies)
- Schedule: Monthly/quarterly treasury operations

*Rationale*: Asset movements require treasury oversight and approval

__**The innovation: Dedicated admins for frequent operations eliminate governance bottlenecks while maintaining multi-sig security.**__


🟢 **Tier 3: High-Frequency Operational Admin Roles**
*High-frequency operational needs demand dedicated admins*

`MONITOR_ADMIN_ROLE` → `MONITOR_ROLE`
- Admin controls: Bot address rotation
- Frequency: High (bot rotation, address management)
- Security: Multiple redundant bots prevent single failure
Rationale: Bots need frequent updates without executive delays

`CRON_JOB_ADMIN_ROLE` → `CRON_JOB_ROLE`
- Admin controls: Automation address management
- Automation functions:
    - Subsidy deposits + Epoch finalization (every 14 days)
    - Pool creation/removal (ad-hoc)
    - escrowOnBehalf (ad-hoc)

*Rationale*: Routine operations can't wait for executives; hence dedicated admins.

🟢 **TIER 4: High-Frequency Operational Roles**
*Direct execution roles for automated systems*

**`MONITOR_ROLE`**
- Functions: pause() across all contracts
- Addresses: Multiple monitoring bots (EOAs)
- Frequency: Rare but critical (emergency pause)
- Security: Monitored by multiple independent bots for redundancy

**`CRON_JOB_ROLE`**
- Functions:
    - VotingEscrowMoca: createLockFor()
    - VotingController: depositEpochSubsidies(), finalizeEpochRewardsSubsidies()
    - VotingController: createPool(), removePool()
- Addresses: Automation EOAs (bi-weekly rotation)
- Frequency: High (every 2 weeks for epoch operations)
- Security: Addresses added temporarily, then removed after operations

**Quick Reference**

| Frequency      | Role Type     | Example Functions                | Management         |
|----------------|---------------|----------------------------------|--------------------|
| Daily/Weekly   | Operational   | Bot rotation, monitoring         | Dedicated admins   |
| Bi-weekly      | Automated     | Epoch operations                 | Dedicated admins   |
| Monthly        | Administrative| Asset withdrawals                | Global admin       |
| Rare           | Strategic     | Parameter updates                | Global admin       |
| Emergency      | Crisis        | System freeze, recovery          | Global admin       |

---

# Operational Model + Execution Workflows

The model supports three tiers of operations, each with tailored processes.

## Three-Tiered Operational Model [*Frequency Principle in Action*]

1. **Autonomous Operations**: Monitoring bots handle alerts and pauses; automated scripts manage epochs. No executive sign-off required.
2. **Governed Strategic Actions**: Contract updates and parameter changes require review and multi-signature approval.
3. **Protected Emergency Controls**: Freezes and recoveries activate only under strict conditions.

This structure ensures fast routine ops, deliberate governance, and robust emergency safeguards; no bottlenecks or unchecked power.

## Execution flows

### 1. **Withdrawing USD8 from PaymentsController (Every 14 days)**

```lua
Time T-1: Preparation
└── Dev team adds EOA address to CRON_JOB_ROLE
Time T: Execution
├── Bot calls depositEpochSubsidies()
├── Bot calls finalizeEpochRewardsSubsidies()
├── Bot withdraws protocol fees and voting fees in USD8
└── Dev team revokes role from EOA address [via dedicated admin]
Time T+1: Verification
└── Back-end confirms successful execution
```
Proceed to convert USD8 to esMoca and deposit into VotingController.

### 2. **Routine Epoch Processing (Every 14 days)**

```lua
Time T-1: Preparation
└── Dev team adds EOA address to `CRON_JOB_ROLE`

Time T: Execution
├── Bot calls `depositEpochSubsidies()`
├── Bot calls `finalizeEpochRewardsSubsidies()`
└── Dev team revokes role from EOA address [via dedicated admin]

Time T+1: Verification
└── Back-end confirms successful execution
```
No executive involvement required; no delays or bottlenecks.

### 3. **Arbitrary Contract Parameter Updates**

```bash
Step 1: Deliberation
└── Discussion on updates to contract parameters

Step 2: Review
├── Technical analysis
└── Economic modeling

Step 3: Approval + Verification + Execution
├── Relevant contact admin multi-sig coordination (e.g. VOTING_CONTROLLER_ADMIN_ROLE)
├── Ensure all multi-sig signers, have signed. 
├── Internal security consultant to verify before submitting for execution
└── Parameter update execution

Step 4: Assessment 
└── Verify changes are in-line with original intention
```
Deliberate process for high-impact changes.

## **Emergency Response (If Needed)**

```bash
Detection → Pause → Assessment → Resolution 

1. Monitor bot detects anomaly
2. Automatic pause (MONITOR_ROLE)
3. Team investigates issue
4. Executive decision on response 
5. Normal operations resume or emergency procedures activate [`freeze` + `emergencyExit`]

EMERGENCY_EXIT_HANDLER_ROLE Execution
Time T-1: Preparation
└── DEFAULT_ADMIN_ROLE grants EMERGENCY_EXIT_HANDLER_ROLE to EOA address attached to script
Time T: Execution
└── Script makes repeated calls to relevant emergency exit functions until completion
Time T+1: Verification
└── Role is revoked (by DEFAULT_ADMIN_ROLE or address self-revokes)
```

## **Other ad-hoc operations (No Executive approval required)**

```bash
Dev/Ops Team → MONITOR_ADMIN_ROLE → Add/Remove monitor bots
Dev/Ops Team → CRON_JOB_ADMIN_ROLE → Add/Remove automation addresses
Monitor Bots → MONITOR_ROLE → Pause contracts if issues detected
Automation Scripts → CRON_JOB_ROLE → Execute bi-weekly epoch operations
```

# Summary and Key Outcomes

This frequency-based role architecture addresses the limitations of traditional models by aligning administrative authority with the operational cadence of each role. 
It optimizes both efficiency and security, via a flexible governance layer that supports real-world operational demands and practical organizational structure.

**Salient Features:**

- **Operational Efficiency:**
  - High-frequency tasks (e.g., bot rotation, routine automation) are managed by dedicated admins, eliminating executive bottlenecks and enabling rapid response.
  - Automated and scheduled operations proceed without delay, supporting continuous protocol function.
  - Clear separation between operational and strategic roles ensures focused responsibility and reduces cross-functional risk.

- **Security and Risk Containment:**
  - Role isolation ensures that compromise of one admin is contained, preventing escalation across unrelated functions.
  - Global admin retains override authority, providing a robust failsafe for critical interventions.
  - Strategic actions require multi-signature approval, maintaining strong oversight for high-impact changes.

- **Governance and Transparency:**
  - Administrative authority is explicitly mapped to operational needs, clarifying responsibilities and reducing ambiguity.
  - All role changes are logged via events, supporting comprehensive audit trails and operational transparency.
  - The model is designed to scale, maintaining clarity and control as protocol complexity grows.

## Comparative Analysis: Traditional vs Frequency-Based RBAC

| **Aspect**                  |<span style="color:red">**Traditional RBAC**</span> | <span style="color:green">**Frequency-Based, Risk-weighted RBAC**</span> |
|:----------------------------|:---------------------------------------------------|:-------------------------------------------------------------------------|
| **Authority Structure**     | Hierarchical, top-down approval                    | Risk-weighted, frequency-aligned                                         |
| **Operational Bottlenecks** | All privileged ops require executive approval      | High-frequency ops have dedicated admins                                 |
| **Emergency Response**      | Delayed by approval chains                         | Immediate response capabilities                                          |
| **Role Granularity**        | Broad permissions or restrictive gates             | Precise matching of authority to operational need                        |
| **Risk Containment**        | Single failure affects entire hierarchy            | Role isolation limits blast radius                                       |
| **Operational Reality**     | Ignores frequency of administrative tasks          | Designed around actual operational patterns                              |
| **Governance Overhead**     | High friction for routine operations               | Strategic oversight where it matters                                     |
| **Scalability**             | Becomes unwieldy as protocol grows                 | Maintains clarity through operational tiers                              |
| **Security Model**          | One-size-fits-all approach                         | Risk-profiled, context-aware permissions                                 |

**Innovation Highlight:**
An RBAC based upon expected frequency and risk profile of operations, is the innovation that allows for streamlining contract administration, risk mitigation and security. 
By focusing on practicality rather than theoretical security models, the AccessController delivers a robust, operationally realistic solution for decentralized protocols.

--- 

# Deployment Process
1. Deploy AccessController with constructor parameters:
   - `globalAdmin`: Executive multisig address
   - `paymentsTreasury`: PaymentsController treasury address
   - `votingTreasury`: VotingController treasury address
   - `esMocaTreasury`: EscrowedMoca treasury address
2. Deploy other contracts → Reference AccessController for permissions
3. Initial role assignment:
   - Grant `MONITOR_ADMIN_ROLE` to dev/ops multisig
   - Grant `CRON_JOB_ADMIN_ROLE` to dev/ops multisig
   - Grant strategic roles directly to appropriate multi-sigs
   - Assign `MONITOR_ROLE` to risk bots
   - Keep the following roles unassigned: `CRON_JOB`, `EMERGENCY_EXIT_HANDLER_ROLE`. These are only assigned temporally and removed after immediately.

## Treasury Management

AccessController maintains three treasury addresses that can be updated by the global admin:
- `PAYMENTS_CONTROLLER_TREASURY`: Treasury address for PaymentsController operations
- `VOTING_CONTROLLER_TREASURY`: Treasury address for VotingController operations
- `ESCROWED_MOCA_TREASURY`: Treasury address for EscrowedMoca operations

Each treasury address can be updated via dedicated setter functions (`setPaymentsControllerTreasury()`, `setVotingControllerTreasury()`, `setEsMocaTreasury()`), all requiring `DEFAULT_ADMIN_ROLE` and preventing zero addresses or setting to the current value.

## Role Administration

The contract provides several mechanisms for role management:

1. **Helper Functions**: For each role, there are dedicated helper functions (`addXxx()`, `removeXxx()`, `isXxx()`) that provide a convenient interface for role management while internally calling OpenZeppelin's `grantRole()` and `revokeRole()` functions. These functions automatically enforce permission checks:
   - `addMonitor()` / `removeMonitor()` require `MONITOR_ADMIN_ROLE`
   - `addCronJob()` / `removeCronJob()` require `CRON_JOB_ADMIN_ROLE`
   - All strategic role helpers require `DEFAULT_ADMIN_ROLE`
   - View functions (`isXxx()`) are publicly accessible

2. **Generic Role Admin Control**: The `setRoleAdmin()` function allows the global admin (`DEFAULT_ADMIN_ROLE`) to modify the admin role hierarchy for any role. This provides flexibility to reorganize the role structure if needed, though the initial setup is configured in the constructor.

3. **Direct OpenZeppelin Functions**: The contract inherits from OpenZeppelin's `AccessControl`, so all standard role management functions (`grantRole()`, `revokeRole()`, `hasRole()`, etc.) are also available with the same permission requirements as the helper functions. 

----

# Appendix

## Function-to-Role Mapping

**VotingEscrowMoca Contract**
- pause(): MONITOR_ROLE
- unpause(), freeze(): DEFAULT_ADMIN_ROLE (Global Admin)
- createLockFor(): CRON_JOB_ROLE
- emergencyExit(): EMERGENCY_EXIT_HANDLER_ROLE

**VotingController Contract**
- pause(): MONITOR_ROLE
- unpause(), freeze(): DEFAULT_ADMIN_ROLE (Global Admin)
- createPool(), removePool(): CRON_JOB_ROLE
- depositEpochSubsidies(), finalizeEpochRewardsSubsidies(): CRON_JOB_ROLE
- Parameter setters: VOTING_CONTROLLER_ADMIN_ROLE
- Asset withdrawals: ASSET_MANAGER_ROLE
- emergencyExit(): EMERGENCY_EXIT_HANDLER_ROLE

**PaymentsController Contract**
- pause(): MONITOR_ROLE
- unpause(), freeze(): DEFAULT_ADMIN_ROLE (Global Admin)
- Parameter updates: PAYMENTS_CONTROLLER_ADMIN_ROLE
- Fee withdrawals: ASSET_MANAGER_ROLE
- Emergency exits: EMERGENCY_EXIT_HANDLER_ROLE


## Execution Flow Analysis

### Verification Flow (PaymentsController)

```
User Verification Request
         │
         ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│   Schema Fee Check  │───►│  Signature Verify   │───►│  Balance Deduction  │
│   • Current fee     │    │  • EIP712 sig       │    │  • USD8 transfer    │
│   • Pending fee     │    │  • Nonce check      │    │  • Fee split        │
│   • Auto-apply      │    │  • Signer validate  │    │  • Subsidy calc     │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│    RISK POINTS      │    │    RISK POINTS      │    │    RISK POINTS      │
│ • Fee manipulation  │    │ • Signature forge   │    │ • Insufficient bal  │
│ • Race conditions   │    │ • Replay attacks    │    │ • Calculation error │
│ • Timing attacks    │    │ • Wrong signer      │    │ • Reentrancy        │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
```

### Voting Flow (VotingController)

```
Vote Casting
         │
         ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│  Voting Power Check │───►│   Pool Validation   │───►│   Vote Recording    │
│  • Personal/Deleg   │    │   • Pool exists     │    │   • Update counters │
│  • Available votes  │    │   • Not removed     │    │   • Emit events     │
│  • Epoch status     │    │   • Vote limits     │    │   • State changes   │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│    RISK POINTS      │    │    RISK POINTS      │    │    RISK POINTS      │
│ • Double voting     │    │ • Pool manipulation │    │ • State corruption  │
│ • Delegate fraud    │    │ • Invalid pools     │    │ • Overflow/underfl  │
│ • Power calculation │    │ • Removed pools     │    │ • Gas limit issues  │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
```

### Reward Distribution Flow

```
Epoch Finalization
         │
         ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│ Subsidy Calculation │───►│  Reward Allocation  │───►│   Claim Processing  │
│ • Pool proportions  │    │  • Pro-rata dist    │    │  • User claims      │
│ • Verifier stakes   │    │  • Fee calculations │    │  • Delegate fees    │
│ • Epoch totals      │    │  • Pool allocations │    │  • Transfer tokens  │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
│    RISK POINTS      │    │    RISK POINTS      │    │    RISK POINTS      │
│ • Calculation error │    │ • Unfair allocation │    │ • Double claiming   │
│ • Rounding issues   │    │ • Precision loss    │    │ • Wrong recipients  │
│ • Pool manipulation │    │ • Timing attacks    │    │ • Token shortfall   │
└─────────────────────┘    └─────────────────────┘    └─────────────────────┘
```

---

## Temporal Dependencies & Epoch Lifecycle

### Time-Based Operations

```
Time-Based Dependencies:
┌─────────────────────────────────────────────────────────────────────────────────┐
│ EPOCH LIFECYCLE (2 week cycles)                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│ Week N-1    │ Week N (Active)  │ Week N+2 (Finalization)  │ Week N+2.X          │
│ ────────────┼──────────────────┼──────────────────────────┼─────────────────────│
│             │ • Voting active  │ • Epoch ends             │ • Claims active     │
│             │ • Verifications  │ • Subsidies deposited    │ • Unclaimed sweep   │
│             │ • Delegations    │ • Rewards calculated     │   (after delay)     │
│             │ • Fee updates    │ • Pools finalized        │                     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```
