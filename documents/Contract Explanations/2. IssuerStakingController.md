# IssuerStakingController Overview

IssuerStakingController.sol lets issuers stake MOCA tokens, with a required delay to unstake. Security is built in with limits, pausing, freezing, and emergency exit features. Only certain roles can take admin actions. 

Off-chain systems check staked balances of issuers to enforce limits on their credential issuances. This is handled within the SDK.

## Table of Contents

- [Key Features](#key-features)
- [1. Contract Overview](#1-contract-overview)
    - [Staking Mechanism](#staking-mechanism)
    - [Unstaking Process](#unstaking-process)
    - [Global State Tracking](#global-state-tracking)
- [2. Design Choices](#2-design-choices)
  - [Time-Delayed Unstaking](#time-delayed-unstaking)
  - [Maximum Stake Limits](#maximum-stake-limits)
  - [Address-Based Issuer Management](#address-based-issuer-management)
- [3. Contract Functions Walkthrough](#3-contract-functions-walkthrough)
  - [stakeMoca()](#stakemoca)
  - [initiateUnstake()](#initiateunstake)
  - [claimUnstake()](#claimunstake)
  - [Administrative Functions](#administrative-functions)
- [4. Execution Flows](#4-execution-flows)
  - [Typical Staking Flow](#typical-staking-flow)
  - [Unstaking and Claiming Flow](#unstaking-and-claiming-flow)
- [5. Integration Points](#5-integration-points)
- [6. Risk Management](#6-risk-management)
- [7. Emergency Procedures](#7-emergency-procedures)
- [8. Upgrade Architecture](#8-upgrade-architecture)
- [Appendix: Technical Deep Dives](#appendix-technical-deep-dives)
  - [Gas Optimization](#gas-optimization)
  - [Precision and Rounding](#precision-and-rounding)
  - [Emergency Scenarios](#emergency-scenarios)

## Key Features

### 1. **Simple Staking Mechanism**
- Direct MOCA token staking with immediate effect
- No complex delegation or voting mechanics

### 2. **Time-Delayed Unstaking System**
- Configurable unstaking delay period (set at deployment and updatable by admin)
- Two-phase unstaking: initiate → wait → claim
- Batch claiming support for multiple timestamps

### 3. **Risk Management Controls**
- Maximum stake amount limits to prevent fat-finger mistakes
- Pause/unpause functionality for operational contingencies
- One-way freeze mechanism with emergency exit procedures
- Multi-tiered access control system

### 4. **Emergency Recovery Mechanisms**
- Fucntions: Pause, Unpause, Freeze, EmergencyExit
- Emergency exit function processes individual issuers
- Only accessible when contract is frozen and by EmergencyExitHandler
- Ensures user funds remain recoverable under all circumstances

---

# 1. **Contract Overview**

## Staking Mechanism

Issuers can stake MOCA tokens directly to the contract, with immediate effect on their staked balance and the global totals.

```solidity
mapping(address issuer => uint256 mocaStaked) public issuers;
```

- **Address-based**: Each issuer address maintains its own staked balance
- **Immediate effect**: Staking takes effect immediately upon transaction confirmation
- **No minimum requirements**: Any amount > 0 and ≤ `MAX_STAKE_AMOUNT` can be staked
- **Cumulative**: Multiple stakes add to existing balance

## Unstaking Process

```solidity
mapping(address issuer => mapping(uint256 timestamp => uint256 pendingUnstake)) public pendingUnstakedMoca;
mapping(address issuer => uint256 totalPendingUnstake) public totalPendingUnstakedMoca;
```

**Two-Phase Process:**
1. **Initiate**: Move tokens from active staked to pending unstake
2. **Claim**: Transfer tokens to issuer after delay period

When tokens are moved to pending unstake, they are decremented in issuers mapping. This reflects that these tokens are no longer actively staked. 

**Timing Mechanism:**
- Unstaking delay is configurable by contract admin.
- Each unstake initiation creates a timestamp-based claimable entry
- Multiple unstakes can be claimed in a single transaction

## Global State Tracking

The contract maintains comprehensive global state for protocol-wide visibility:

```solidity
uint256 public TOTAL_MOCA_STAKED;            // Active staked tokens
uint256 public TOTAL_MOCA_PENDING_UNSTAKE;   // Tokens awaiting claim
uint256 public UNSTAKE_DELAY;               // Delay period for unstaking
uint256 public MAX_STAKE_AMOUNT;            // Maximum single stake amount
```

**State Consistency:**
- Global totals are updated atomically with individual issuer balances
- Pending unstake amounts are tracked separately from active stakes
- All state changes emit events for comprehensive audit trails

---

# 2. **Design Choices**

## Time-Delayed Unstaking

The unstaking delay serves multiple security purposes:

**Rationale:**
- **Slashing Protection**: Prevents immediate withdrawal during disputes
- **Economic Stability**: Reduces volatility from rapid stake changes

**Implementation:**
- Delay period is set at deployment and can be updated by admin
- Each unstake initiation calculates claimable timestamp: `block.timestamp + UNSTAKE_DELAY`
- Tokens remain in contract during delay period

## Maximum Stake Limits

The `MAX_STAKE_AMOUNT` parameter prevents excessive single transactions:

**Rationale:**
- **Fat-finger Protection**: Prevents accidental large stakes
- **Risk Management**: Limits exposure from single transaction errors

**Flexibility:**
- Can be updated by admin as protocol matures
- Applies per transaction, not cumulative balance
- Issuers can stake multiple times up to the limit; but this would be an intentional choice on their part.

---

# 3. **Contract Functions Walkthrough**

## `stakeMoca()`

The primary staking function enables issuers to stake MOCA tokens:

```solidity
function stakeMoca(uint256 amount) external whenNotPaused
```

**Process Flow:**
1. **Validation**: Checks amount > 0 and ≤ MAX_STAKE_AMOUNT
2. **State Updates**: Increments issuer balance and global totals
3. **Token Transfer**: Transfers MOCA from issuer to contract
4. **Event Emission**: Records staking event for audit trail


## `initiateUnstake()`

Initiates the unstaking process, moving tokens to pending state:

```solidity
function initiateUnstake(uint256 amount) external whenNotPaused
```

**Process Flow:**
1. **Validation**: Checks amount > 0 and ≤ issuer's staked balance
2. **Timestamp Calculation**: Determines claimable timestamp
3. **State Updates**: 
   - Decrements active staked balance
   - Increments pending unstake amount
   - Updates global totals
   - Updates `totalPendingUnstakedMoca` mapping
4. **Event Emission**: Records unstake initiation with timestamp

Each unstake gets unique claimable time; multiple unstakes at different times, create separate timestamps.

## `claimUnstake()`

Claims unstaked tokens after the delay period:

```solidity
function claimUnstake(uint256[] calldata timestamps) external whenNotPaused
```

**Process Flow:**
1. **Early Validation**: Checks array length and `totalPendingUnstakedMoca` > 0
2. **Timestamp Validation**: Verifies delay period has passed for each timestamp
3. **Amount Calculation**: Sums all claimable amounts
4. **State Cleanup**: Deletes pending entries and updates totals
5. **Token Transfer**: Transfers MOCA to issuer
6. **Event Emission**: Records claim event

**Batch Processing:**
- **Efficiency**: Claim multiple unstakes in single transaction 
- **Gas Savings**: Reduces transaction overhead
- **User Experience**: Simplified claiming process

## Admin Functions: Parameter Management

**`setUnstakeDelay()`**: Updates the unstaking delay period

```solidity
function setUnstakeDelay(uint256 newUnstakeDelay) external onlyIssuerStakingControllerAdmin whenNotPaused 
```

- Only callable by IssuerStakingController admin
- Affects future unstake initiations only
- Emits event with old and new values

Updates made are forward-looking. I.e. if issuer calls `initiateUnstake()`, and then subsequently `UNSTAKE_DELAY` is lowered, it will only impact incoming `initiateUnstake()`.
Prior and pending unstakes initiated, will be as per the `UNSTAKE_DELAY` at the time of function call.  


**`setMaxStakeAmount()`**: Updates maximum stake limit

```solidity
function setMaxStakeAmount(uint256 newMaxStakeAmount) external onlyIssuerStakingControllerAdmin whenNotPaused
```

- Only callable by IssuerStakingController admin
- Affects future stake transactions only
- Emits event with old and new values

Sanity blocker: newMaxStakeAmount cannot exceed 90 days.

---

# 4. **Execution Flows**

## Typical Staking Flow

1. **Issuer Decision**: Issuer decides to stake MOCA tokens
2. **Approval**: Issuer approves MOCA transfer to `IssuerStakingController`
3. **Stake Transaction**: Issuer calls `stakeMoca(amount)`
4. **Contract Processing**:
   - Validates amount and limits
   - Updates issuer balance and global totals
   - Transfers MOCA tokens
   - Emits staking event
5. **Confirmation**: Staking complete, tokens locked in contract

## Unstaking and Claiming Flow

1. **Unstake Initiation**: Issuer calls `initiateUnstake(amount)`
2. **Contract Processing**:
   - Validates amount against staked balance
   - Calculates claimable timestamp
   - Moves tokens to pending state
   - Updates both timestamp-specific and total pending mappings
   - Emits unstake initiation event
3. **Waiting Period**: Tokens remain locked for `UNSTAKE_DELAY`
4. **Claim Preparation**: Issuer identifies claimable timestamps
5. **Claim Transaction**: Issuer calls `claimUnstake(timestamps[])`
6. **Contract Processing**:
   - Early validation using `totalPendingUnstakedMoca`
   - Validates timestamps and amounts
   - Transfers MOCA tokens to issuer
   - Cleans up pending entries and updates totals
   - Emits claim event

---

# 5. **Integration Points**

## With AccessController
- **Role-based Access**: Enforces admin permissions
- **Risk Management**: Integrates with pause/unpause mechanisms
- **Emergency Procedures**: Coordinates with emergency exit handlers
- **Treasury Access**: Emergency exit transfers to treasury address

*Note that there is no direct integration with PaymentsController.sol. Though one might consider it sensible to do so, so that issuerAsset addressess can be consistently tracked and logged protocol-wide. We choose to leave this for a v2 implementation; should it be considered necessary.*

---

# 6. **Risk Management**

## Access Control Hierarchy

### Operational Roles
- **IssuerStakingController Admin**: Configure parameters and limits
- **Monitor**: Pause contract in emergencies
- **Global Admin**: Unpause and freeze operations
- **Emergency Exit Handler**: Recover funds when frozen

### Security Features

1. **Pausable Operations**
   - All state-changing functions check pause status
   - Monitor can pause, only Global Admin can unpause
   - Prevents damage during active incidents

2. **Freeze Mechanism**
   - One-way operation requiring contract to be paused first
   - Enables emergency exit procedures
   - Cannot be reversed - kill-switch

3. **Parameter Limits**
   - Maximum stake amounts prevent excessive transactions
   - Configurable unstaking delays provide security buffer
   - Admin controls maintain operational flexibility

---

# 7. **Emergency Procedures**

## Emergency Exit Process

The `emergencyExit()` function provides a targeted recovery mechanism:

```solidity
function emergencyExit(address[] calldata issuerAddresses) external onlyEmergencyExitHandler
```

**Prerequisites:**
- Contract must be frozen (`isFrozen == 1`)
- Only callable by Emergency Exit Handler role
- Must provide non-empty array of issuer addresses

**Process:**
1. **Validation**: Confirms frozen state and non-empty address array
2. **Batch Processing**: Iterates through each issuer address
3. **Amount Calculation**: Sums staked and pending MOCA per issuer
4. **Token Transfer**: Transfers MOCA directly to each issuer
5. **State Cleanup**: Resets issuer balances and updates global totals
6. **Event Emission**: Records emergency exit with processed addresses and total MOCA

**Key Improvements:**
- **Targeted Recovery**: Processes specific issuers instead of transferring everything to treasury or otherwise
- **Direct User Access**: Users receive their MOCA directly, not through treasury
- **Batch Efficiency**: Handles multiple issuers in single transaction
- **Selective Processing**: Skips issuers with zero balances automatically

**Recovery Implications:**
- **User Impact**: Affected issuers receive their MOCA directly
- **State Reset**: Processed issuer balances reset to zero
- **Irreversible**: Cannot be undone once executed

## Emergency Scenarios

### Scenario 1: Critical Bug Discovery / Contract Compromise
1. Monitor calls `pause()` - stops all operations
2. Team investigates and determines response or fix timeline
3. If fixable: Deploy fix, `unpause()` when safe
4. If critical: `freeze()` and initiate emergency exit for affected issuers

### Scenario 2: Malicious Admin [Parameter Manipulation]
1. Cannot steal funds (only configure parameters)
2. Can manipulate limits: Admin sets extreme parameters (very long delays, very low limits)
3. Users affected by parameter changes
4. Remove Malicious admin through AccessController.
4. Worst case: Emergency exit recovers funds for specific issuers

### Scenario 3: Contract Upgrade Failure
1. Old contract continues operating normally
2. If new contract has issues: freeze + redeploy
3. If migration fails: emergency exit for affected issuers
4. User funds always recoverable through emergency procedures

### Others: Integration With Risk Management
- Pause mechanisms coordinate with other protocol contracts
- Freeze procedures provide system-wide emergency response
- Emergency exit ensures user fund recovery across all scenarios

---

# 8. **Upgrade Architecture**

## Upgrade Process

1. **Deploy** new IssuerStakingController version
2. **Configure** new contract with existing parameters
3. **Update** SDK and off-chain mechanisms to point to new contract
4. **Notify** issuers to migrate stakes (unstake → re-stake)
5. **Freeze** old contract once migration complete

## Design for Upgradeability

- **Clean Interfaces**: Simple staking/unstaking operations
- **State Isolation**: Each issuer's stake is independent
- **Emergency Recovery**: Ensures no funds locked during transition

---

# 9. Coverage

Coverage reports are generated individually per contract and their corresponding test files.

- Coverage is full, when if statements are used, versus require - for errors.
- However, since we are using require statements, it incorrectly indicates that tests are missing.

╭---------------------------------------------------+-------------------+-------------------+---------------+-----------------╮
| File                                              | % Lines           | % Statements      | % Branches    | % Funcs         |
+=============================================================================================================================+
| src/AccessController.sol                          | 27.12% (32/118)   | 32.61% (30/92)    | 0.00% (0/8)   | 20.51% (8/39)   |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| src/EscrowedMoca.sol                              | 10.34% (15/145)   | 8.97% (13/145)    | 0.00% (0/78)  | 13.04% (3/23)   |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| src/IssuerStakingController.sol                   | 97.73% (86/88)    | 97.65% (83/85)    | 11.63% (5/43) | 100.00% (15/15) |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| src/PaymentsController.sol                        | 3.75% (12/320)    | 3.49% (11/315)    | 0.00% (0/158) | 2.22% (1/45)    |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| src/VotingController.sol                          | 0.00% (0/420)     | 0.00% (0/467)     | 0.00% (0/224) | 0.00% (0/38)    |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| src/VotingEscrowMoca.sol                          | 0.72% (3/415)     | 0.44% (2/457)     | 0.00% (0/152) | 2.08% (1/48)    |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| src/archive (ignore)/utils/RevertMsgExtractor.sol | 0.00% (0/4)       | 0.00% (0/5)       | 0.00% (0/1)   | 0.00% (0/1)     |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| src/libraries/EpochMath.sol                       | 11.11% (2/18)     | 15.79% (3/19)     | 100.00% (0/0) | 11.11% (1/9)    |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| test/IssuerStakingController.t.sol                | 77.78% (42/54)    | 72.09% (31/43)    | 100.00% (0/0) | 100.00% (12/12) |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| test/utils/MockMoca.sol                           | 33.33% (2/6)      | 33.33% (1/3)      | 100.00% (0/0) | 33.33% (1/3)    |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| test/utils/MockUSD8.sol                           | 33.33% (2/6)      | 33.33% (1/3)      | 100.00% (0/0) | 33.33% (1/3)    |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| test/utils/TestingHarness.sol                     | 77.14% (54/70)    | 69.74% (53/76)    | 100.00% (0/0) | 20.00% (1/5)    |
|---------------------------------------------------+-------------------+-------------------+---------------+-----------------|
| Total                                             | 15.79% (271/1716) | 13.97% (244/1747) | 0.74% (5/674) | 19.23% (50/260) |
╰---------------------------------------------------+-------------------+-------------------+---------------+-----------------╯

